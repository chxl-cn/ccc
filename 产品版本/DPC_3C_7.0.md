3C Version Publish - V7.0.0
=================
  
版本修订
-----------------------------------

日期 | 作者 |  说明
-|-|-
2019/11/8| author:xuyong| add

目标
-----------------------------------
基于加密解密方案对DPC_3C数据终端进行数据保护

开发计划
-----------------------------------
SPRINT1: 2019/10/24 - 2019/11/14 延期至 2019/11/16  
SPRINT2: 2019/10/18 - 2019/11/30

版本服务/组件列表
-----------------------------------
  
服务/组件 | 版本号 |  是否更新 |升级内容
-|-|-|-
 云转发| 3CDataTransmitterBroker_V1.5 | 无 |-
 3C数据接收服务| FileReceiveWeb_V3.0 | 无 |-
 现场解析服务| 3CDataInterfaceSite_V4.0 | 有 |加密敏感字段，不支持旧版本升级
 动机车对外数据终端网站| DPC_3C_O_7.0.0 | 有 |数据保护方案，不支持旧版本升级
 3C缺陷报告生成服务| CreateDoc_V1.7 | 有 |数据保护方案，兼容以前版本升级
 3C数据解析WebAPI接口| DPC_3C_Parser_WebAPI_V3.0.0 | 有 |数据保护方案，兼容以前版本升级
 迁移工具| TransData_V1.0.0 | 有 |铁科MySql数据加密迁移，alarm/sms数据通过加密输出csv、脚本文件和批处理文件

完成情况总结
-----------------------------------

1. 现场解析服务
    1. 功能验证通过
    2. 性能评估：alarm不再提图但要加密，较之前变化不大；sms数据因为加密，略有降低，但性能没问题。
2. 数据终端网站
    1. 功能验证通过
    2. 加密设计后性能评估  
        1)报警列表分页查询影响：如果redis没有热数据，会查询数据库解密出结果  
        2)报警详情实时提图：实时提图采用非技术部不曝光，会增加大约1S的响应延迟，但整体体验可以接受。  
        3)导出功能或非分页查询影响：对于非热数据的查询如果单条调用数据组件API，存在性能问题；这里采用查询前批量查询和刷新Redis操作，然后再单条数据更新。  
    3. 性能优化:主要报警查询删除left join alarm_aux,alarm_img_data；然后通过单表的ID查询后回填，性能有较大提升。
3. 提图API
    1. 默认情况MV采用非技术部DLL提图,不曝光性能比较理想
4. 数据迁移
    1. 最初尝试过查询之后，调用API直接写入数据库，但是性能不是很理想，且无优化空间。
    2. 最终方案：加密之后将nos_aa,nos_ac的数据写入到多个csv,同时生成批量导入脚本和批次处理文件，最后人工导入，性能提升了很多。
5. 遗留问题
    1. 网站遗留不重要、不影响正常使用、不易解决的BUG。
    2. 优化提图性能和曝光问题。

数据保护组件 - Safeguard_V1.0
-----------------------------------
### 版本号
V1.0.0
### 更新内容
1. 基础数据加密
TSYS_ORG，SYS_DIC，MIS_PARAMTER，VIRTUAL_DIR_INFO，LOCOMOTIVE，MIS_BRG_TUN，MIS_LINE，MIS_POSITION，MIS_LKJ
2. 业务数据加密
Alarm,ALARM_HIST，ALARM_AUX，ALARM_IMG_DATA，C3_Sms，GETFILETASK_QUEUE，FILETASKDATA  
详情见附件地址：[数据安全加密和解密详细设计](../安全加固/数据安全加密和解密详细设计.md)  

动机车对外数据终端网站 - DPC_3C_O_7.0.0
-----------------------------------
### 版本号
V7.0.0
### 更新内容

1. 检测数据、缺陷库、预警信息
    1. 列表信息展示及更多条件查询功能（不包括查询条件中的去重复）；  
    2. 导出excel、导出excel带图像；  
2. 缺陷库/预警信息/检测数据/详情页
    1. 详情页信息展示；
    2. 预览缺陷报告；
    3. 红外测温
3. GIS分析
    1. 列表信息展示及更多条件查询功能；
    2. 导出excel列表;
4. 重复报警分析
    1. 重复报警分析功能（线路分析/GIS分析）
    2. 重复报警导出excel;
    3. 分析对比页信息展示（不包括图片播放）
5. 在线实时检测
    1. 数据解密
    2. 实时提图
    3. 存储过程 loco_curr_stat
6. 主动检测
    1. 数据字段解密
    2. 实时提图
    3. 红外测温
7. 车顶实时直播
    1. 树列表加载
8. 检测运行轨迹
    1. 存储过程
9. 设备状态监测
    1. 存储过程
10. 统计报表
    1. 所有rdlc报表的字段统一
    2. 存储过程加密字段调整
11. 系统管理
    1. 去掉基础数据编辑功能
12. 其他（性能优化）
    1. 主要报警列表查询SQL原有left join alarm_img_data,left join alarm_aux去掉，仅查询alarm，其他数据查询出alarmid后单独批量查询
    2. 加密数据默认情况下调用SafeguardManager api逐条获取；部分不分页查询报警数据功能调用SafeguardManager.Refresh(idList)批量更新redis后再逐条获取。
    3. 报警上下条功能：当前页会有session，下一条首先从session中查询
13. BUG修复
    1. 以上所有rdlc报表的字段统一；  
    2. 删除位置信息中的车次号；  
    3. 缺陷列表中燃弧信息展示错误（燃弧信息三个字段取的相同值）；  
    4. 缺陷列表中组织机构无数据（供电用户登录）；  
    5. 缺陷确认、缺陷取消框里面的字段统一  
    6. 检测信息列表更多条件字段统一  
    7. 删除首页html里面的敏感注释  
    8. 缺陷详情页里面的车次号展示调整
    9. GIS页，缺陷信息弹框中的缺陷状态改为状态
    10. 重复报警分析，查询条件区站换成使用position_code查询
    11. 扩展插件修改，防止向后端传值时url过长问题
    12. 前端页面字段统一
    13. 增加燃弧信息（缺陷库/预警信息/检测数据）
    14. 增加车次号信息（在线实时监控/重复报警分析对比详情页/GIS分析/轨迹）
    15. 屏蔽人员管理里面的密码策略
    16. 调整列表页鼠标移入移出效果
    17. 选中记住密码后，cookie中的用户密码加密
    18. 调节亮度页面可见光图片跨域获取

### 配置变更

1. mis_parameter
    1. PARSER_API_001	AlarmIRVPIC_API	http://192.168.3.193:7001	提图服务api	3C_DataCenter	2019-04-15 15:04:13
    2. PARSER_API_002	AlarmMV2PIC_API	http://192.168.3.193:7001	提图服务api	3C_DataCenter	2019-04-15 15:04:13
    3. PARSER_API_003	AlarmMV3PIC_API	http://192.168.3.193:7001	提图服务api	3C_DataCenter	2019-04-15 15:04:13
    4. PARSER_API_004	AlarmIRVTEMP_API	http://192.168.3.193:7001	提图服务api	3C_DataCenter	2019-04-15 15:04:13
    5. 屏蔽所有单引号请求： 
    ``` sql
    update mis_paramter set value=" and | exec | insert | select | delete | update | chr | mid | master | or | truncate | char | declare | join | execute | count | drop | sitename | net user | xp_cmdshell | script | execute |create | drop | table | from | grant | use | group_concat | column_name | information_schema.columns | table_schema | union | where | order | by | count | like |''|--|*|/*|*/|%%|like''|'" where key='IllegalChar'
    ```
2. 数据库结构（见数据库迁移文档）

现场解析服务 - 3CDataInterfaceSite_V4.0
-----------------------------------
### 版本号
V4.0.0 
### 更新内容
1. 迁移支持dotnet core
2. 解析syn文件，加密字段调用数据保护组件单独输出
3. 删除提图功能

3C缺陷报告生成服务 - CreateDoc_V1.7
-----------------------------------
### 版本号
V1.7.0
### 更新内容
1. 基于Oracle 1.6版本开发，支持Mysql数据库
2. 适配加密字段，调用数据保护组件解密数据
3. 通过配置项支持实时提图

3C数据解析WebAPI接口 - DPC_3C_Parser_WebAPI_V3.0.0
-----------------------------------
### 版本号
V3.0.0
### 更新内容
1. dlv提图（支持3C报警文件和主动检测999文件）
2. dlv红外测温（支持3C报警文件和主动检测999文件）
3. mv提图（支持3C报警文件和主动检测999文件）
4. 支持图片缓存，支持提图后时间更新（可配置，默认5分钟）
### 注意
1. mv非技术部dll提图曝光不支持
2. dlv非技术部提图和测温不支持
3. dlv技术部提图接口：Save图片文件和get内存byte[]函数存在差异

3C mysql 数据迁移工具 - TransData_V1
-----------------------------------
### 版本号
V1.0.0
### 功能说明
1. 报警数据支持按时间段查询后输出csv文件和导入脚本，运维执行脚本后批量导入
2. 状态日志数据同报警数据机制
3. 支持基础数据的全量迁移（不提供单条数据迁移）
4. 支持数据解密

注意事项/迁移建议
-----------------------------------
1. 停用旧现场解析服务和数据终端
2. 首先数据库结构升级（不要删加密字段）
3. 迁移基础数据
4. 迁移近期的报警和状态数据
4. 为了不要长时间影响业务，启动新解析服务
5. 迁移历史的报警和状态数据
6. 迁移完成，删除加密字段
7. 启用数据终端（这一步可以在4完成后同步执行）