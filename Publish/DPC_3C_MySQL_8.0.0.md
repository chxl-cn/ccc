3C Version Publish - V8.0.0
=================
  
版本修订
-----------------------------------

日期 | 作者 |  说明
-|-|-
2019/11/8|xuyong| add：V7.0
2019/11/27|xuyong| modify
2019/12/10|xuyong| modify
2020/03/02|xuyong| version : V7.1.1
2020/03/09|xuyong| version : V8.0

目标
-----------------------------------

基于mysql V7.1版本，依据2020/3/4动车3C性能讨论结果为指导，从下面的几方面需求考虑：

1. 统一模型：主要是alarm，c3_sms
2. 读写分离:热数据写到实时库，通过工具同步到历史库
3. 应用层:控制请求实现系统的自我保护
4. 内存数据库应用
5. 中间表设计
6. mysql的性能要求
7. 对内需求

场景和设计
-----------------------------------

基于功能需求和非功能需求设计主要性能目标：设计容量500台车，每天10万条报警，72万条状态日志；Alarm和C3_SMS按天建分区;100人同时在线.  
目标期望：通过模型重构、分库分表和部分业务重构后，alarm/c3_sms的查询SQL都是单表查询，理论上能满足预定的性能要求。  
需要研究的问题：按500台车1年的数据量，alarm单表查询SQL性能还需要通过压力测试模拟，评估出一个参考值。

1. 写数据场景
    1. 日志解析性能指标：500*1.2条/分钟（现场解析/对内解析）
    2. 报警解析性能指标：70条/分钟（现场解析/对内解析，目前未存Redis，需要考虑存Redis）
    3. AI结果识别性能指标：70条/分钟（对内网站性能要求？）
    4. 报警详情性能指标：100*10条/分钟（对内网站性能要求：目前报警确认性能很差，需要考虑通过内存表延迟入库）
2. 报警检索场景
    1. 查询当天默认的报警数据：100人*10请求/分钟，这个指标还需要写代码实际测试
    2. 查询2天报警数据：/
    3. 查询一周报警数据：/
    4. 查询一个月带限制条件报警数据：100人*1请求/天
    5. 统计日报：考虑通过调度使用中间表预汇总，查询直接展示
    6. 统计月报：考虑通过调度使用中间表预汇总，查询直接展示
    7. 统计周报：考虑通过调度使用中间表预汇总，查询直接展示
    8. 重复报警分析：考虑通过调度使用中间表预汇总
3. 报警详情处理场景
    1. 单条报警请求：100人*10次请求/分钟，查询通过ID从Redis获取，报警确认时仅实时写报警表更新Redis，历史表延时更新。
    2. 上一条/下一条：100人*10次请求/分钟
4. 日志检索场景
    1. 查询当天默认的日志数据：默认不加载数据，100人*0.1请求/分钟
    2. 查询2天日志数据：/
    3. 查询一周日志数据：/
    4. 查询一个月带限制条件日志数据：/
    5. 查看指定车辆检测轨迹:/
    6. 查看指定车辆运行轨迹:/
5. Redis缓存场景
    1. 加密数据写DB同步更新Redis,通过报警ID获取单条数据
    2. 非加密报警数据通过解析和网站更新，同样通过报警ID获取单条数据
    3. 基础数据直接缓存至内存
    4. 报表服务和网站采用Redis交互获取待处理报表
6. 中间表和预统计处理设计
    1. 报警列表的重复统计，用于列表查询中的支柱重复报警统计：设计待定，可以用中间表或Redis实现
    2. 统计功能：通过数据库调度生成输出中间统计表

参考：

1. [加密解密数据保护方案](../OutNext/数据安全加密和解密详细设计.md)  
2. [MySQL统一模型和性能提升方案](../OutNext/MySQL统一模型解决方案.md)  
3. [MySQL数据库模型详情](../Components/01Design)  

开发计划
-----------------------------------

1. SPRINT1: 2020/03/16 - 2020/04/03 对外Mysql性能提升：统一模型，读写分离等性能问题
2. SPRINT2:对内网站需求，手机APP；将对内oralce升级至mysql版本；

版本服务/组件列表
-----------------------------------
  
服务/组件 | 版本号 |  是否更新 |升级内容
-|-|-|-
 云转发| 3CDataTransmitterBroker_V1.4.1 | 无 |-
 3C数据接收服务| FileReceiveWeb_V2.1.2 | 无 |-
 现场解析服务| 3CDataInterfaceSite_V4.1 | 有 |模型重构
 动机车对外数据终端网站| DPC_3C_O_8.0.0 | 有 |统一模型，读写分离,SQL优化
 3C缺陷报告生成服务| CreateDoc_V1.9 | 有 |统一模型
 3C数据解析WebAPI接口| DPC_3C_Parser_WebAPI_V3.3.0 | 有|统一模型，读写分离
 转发服务| 3CTransmit_5.11.0 | 有 |模型重构
 迁移工具| TransData_V1.2 | 有 |功能优化，方便运维
 数据同步工具| - | 有 |DBA工具，支持实时库同步至历史库

公用组件 - SinoRail.DPC.3C_4.1
-----------------------------------

1. 提供数据库适配API：通过时间参数获取数据库地址
2. 原有数据保护组件支持分库查询
3. 原有数据保护API提供分库支持

现场解析服务 - 3CDataInterfaceSite_V4.1·0
-----------------------------------

1. alarm报警模型重构和代码优化
2. c3_sms状态数据模型重构和代码优化
3. 更新组件SinoRail.DPC.3C

动机车对外数据终端网站 - DPC_3C_O_8.0.0
-----------------------------------

1. 更新组件SinoRail.DPC.3C
2. 报警模块
    1. alarm报警模型重构和代码优化
    2. alarm查询sql适配
    3. alarm分库的支持
3. 状态数据模块
    1. c3_sms报警模型重构和代码优化
    2. c3_sms查询sql适配
    3. c3_sms分库的支持
4. 控制请的自我保护
5. 存储过程更新（楚学亮）
6. 报表任务消息机制重构

3C缺陷报告生成服务 - CreateDoc_V1.9
-----------------------------------

1. 代码适配新模型
2. 更新组件SinoRail.DPC.3C，多数据库适配
3. 报表任务消息机制重构

转发服务 - 3CTransmit_5.11.0
-----------------------------------

1. c3_sms报警模型重构
2. alarm报警模型重构
3. Trans_data增删逻辑的优化，该表实质是一张热数据的临时表，尽量让该表的数据量最小化

3C数据解析WebAPI接口 - DPC_3C_Parser_WebAPI_V3.3.0
-----------------------------------

1. 统一模型
2. 数据分库适配（公用组件）

迁移工具 - TransData_V1.2
-----------------------------------

1. 功能优化，便于运维升级维护

同步工具/方案 - DBSyn_V1.0
-----------------------------------

1. 由楚学亮研究提供
2. 支持实时库将数据同步至历史库
3. 历史数据的迁移

SQL脚本
-----------------------------------

```sql
create table train6c.xt_dbconfig
(
   name                 varchar(31) not null,
   usetype              int(1) comment '数据库用途：0实时库 1当年库 2历史库',
   usedays              int comment '使用天数：实时库配置',
   startdate            date,
   enddate              date,
   createtime           datetime,
   IsEncryptionDb       int(1) comment '是否加密',
   dbtype               varchar(15) comment '数据库类型:mysql',
   dbconn               varchar(511) comment '数据库连接串',
   dbinfo               varchar(511) comment '描述',
   primary key (name)
);
INSERT INTO ``(`name`, `usetype`, `usedays`, `startdate`, `enddate`, `createtime`, `IsEncryptionDb`, `dbtype`, `dbconn`, `dbinfo`) VALUES ('default_db', 0, 366000, NULL, '2040-03-12', '2020-03-12 13:18:17', 0, 'mysql', 'Database=train6c;Data Source=10.2.2.169;User Id=root;Password=123456Aa;CharSet=utf8;port=3306', '实时库');
```
