3C doc - 数据加密和解密方案
=================
  
版本修订
-----------------------------------
+ 2019/10/24  author:xuyong  add  


设计思路
-----------------------------------
3C数据的重要性不言而喻，对于一些敏感数据采用加密存储后可以在一定程度上起到保护效果。数据加密保护后，则需要通过解密才能使用，这样数据的读写就很复杂，下面就是通过统一的数据加解密和存储方案。  
1.解析服务写数据时，调用C3Safeguard数据保护组件Save方法，传入预定义好的key+Model  
2.C3Safeguard.Save将model序列化后加密存储至mysql和redis  
3.读取数据时，通过key调用C3Safeguard.Query方法获取对应的Model数据  

需要加密的数据
-----------------------------------
字典字段不必调用get接口，直接程序启动时加载缓存数据至内存的字典集合中，使用时通过KEY直接获取性能更高  
### 基础表
#### TSYS_ORG -> nos_ba
ORG_NAME
SUP_ORG_NAME
#### SYS_DIC -> nos_bb
CODE_NAME
#### MIS_PARAMTER -> nos_bc
VALUE
#### VIRTUAL_DIR_INFO -> nos_bd
PHYSICAL_DIR_PATH
PATH
#### LOCOMOTIVE -> nos_be
P_ORG_NAME,
ORG_NAME,
BUREAU_NAME,
PHONE_NUMBER,
DEVICE_VERSION[不加密，存储过程计算使用],
DEVICE_BOW_RELATIONS[不加密，存储过程计算使用],
BOW_OFFSETS，
EOAS_OFFSETS
#### MIS_BRG_TUN -> nos_bf
BRG_TUN_NAME，
POSITION_NAME
#### MIS_LINE -> nos_bg
LINE_NAME，
BUREAU_NAME
#### MIS_POSITION -> nos_bh
POSITION_NAME，
LINE_NAME，
ORG_NAME，
WORKSHOP_NAME，
POWER_SECTION_NAME，
BUREAU_NAME
#### MIS_LKJ -> nos_bi
暂不做
### 业务表
#### Alarm -> nos_aa
1. 冗余相关字段，通过字典查询  
LINE_NAME,
POSITION_NAME,
BRG_TUN_NAME,
P_ORG_NAME,
ORG_NAME,
WORKSHOP_NAME,
POWER_SECTION_NAME,
BUREAU_NAME,
SUBSTATION_NAME,
CODE_NAME,
STATUS_NAME,
2. 加密字段  
GIS_X,
GIS_Y,
GIS_X_O,
GIS_Y_O,
SUMMARY,
DETAIL,
ALARM_ANALYSIS[已删除，影响查询],
POLE_NUMBER[已删除，查询条件字段不加密]，
PROPOSAL,
DIR_PATH,
SVALUE1,
SVALUE2,
SVALUE3,
SVALUE4,
SVALUE5,
SVALUE9,
SVALUE11,
SVALUE14,
EOAS_TRAINNO,
DEVICE_ID,
NVALUE10,
### ALARM_AUX -> nos_aa
AFLG_NAME，
INITIAL_CODE_NAME，
ACFLAG_NAME，
MAP_ADD_IMA，
VI_ADD_IMA，
OA_ADD_IMA，
SAMPLE_NAME，
SCENCESAMPLE_NAME，
SAMPLE_CODE，
SAMPLE_DETAIL_CODE，
SAMPLE_DETAIL_NAME，
ALGCODE，
SCENCESAMPLE_CODE，
ALGCODENAME，
LOCK_PERSON_ID,[已删除，不加密保持原代码一致], 
### ALARM_IMG_DATA -> nos_aa
SPART_PIXELS，
GRAY_AVG_LEFT，
GRAY_AVG_RIGHT，
GRAY_AVG_BOW_RECT，
SPART_PIXEL_PCT，
SPARK_SHAPE，
SPARK_NUM，
SPARK_ELAPSE[已删除，影响统计询]
ISBLACKCENTER
### alarm_hist -> nos_ab
同alarm
### C3_SMS -> nos_ac
LINE_NAME，
POSITION_NAME，
GIS_LON_O，
GIS_LAT_O，
GIS_LON，
GIS_LAT，
BUREAU_NAME，
P_ORG_NAME，
POWER_SECTION_NAME，
ORG_NAME，
ROUTING_NO，
AREA_NO，
STATION_NO，
STATION_NAME，
TRAIN_NO，
POLE_CODE，
POLE_NO,
log_filename,
log_file_path 
### GETFILETASK_QUEUE-> nos_ad
FILEURL_NET
### FILETASKDATA-> nos_ae
IRV_DIRID，
VI_DIRID，
OV_DIRID，
AUX_DIRID，
SCS_DIRID，
MP4_DIRID


业务流程
-----------------------------------
### 
#### 
![Image text](../images/safe_project.png)


类设计
-----------------------------------
### models 
C3OrgInfo
```c#
    /// <summary>
    /// 组织机构
    /// </summary>
    public class C3OrgInfo
    {
        /// <summary>
        /// Id
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// Code
        /// </summary>
        public string Code { get; set; }
        /// <summary>
        /// Name
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// SupName
        /// </summary>
        public string SupName { get; set; }
        /// <summary>
        /// Layer
        /// </summary>
        public string Layer { get; set; }
        /// <summary>
        /// Degree
        /// </summary>
        public string Degree { get; set; }
        /// <summary>
        /// Type
        /// </summary>
        public string Type { get; set; }
        /// <summary>
        /// IsLeaf
        /// </summary>
        public bool IsLeaf { get; set; }
        /// <summary>
        /// IsGrouped
        /// </summary>
        public string IsGrouped { get; set; }

    }
```
C3BrgTunInfo
```c#
    /// <summary>
    /// 桥隧
    /// </summary>
    public class C3BrgTunInfo
    {
        /// <summary>
        /// Id
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// Code
        /// </summary>
        public string Code { get; set; }
        /// <summary>
        /// Name
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// Type
        /// </summary>
        public string Type { get; set; }
        /// <summary>
        /// PositionName
        /// </summary>
        public string PositionName { get; set; }
        /// <summary>
        /// Direction
        /// </summary>
        public string Direction { get; set; }
        /// <summary>
        /// Order
        /// </summary>
        public int Order { get; set; }
    }
```
### class
C3Safeguard  


接口调用
-----------------------------------
TODO: 程序启动时注入代码
```c# 
    // 读取配置项
    string redisStr = "192.168.1.231:7001,192.168.1.231:7002,192.168.1.231:7003,192.168.1.231:7004,192.168.1.231:7005,192.168.1.231:7006,password=,connectTimeout=1000,connectRetry=5,syncTimeout=10000";
    string connStr = "Database=train6c;Data Source=192.168.1.250;User Id=nhs3c;Password=123456Aa;CharSet=utf8;port=3306";
    DbProviderFactories.RegisterFactory("MySql.Data.MySqlClient", new MySql.Data.MySqlClient.MySqlClientFactory());
    DbProviderFactory factory = DbProviderFactories.GetFactory("MySql.Data.MySqlClient");
    // 初始化redis
    string message = string.Empty;
    var cache = new SinoRail.DPC.Cache.RedisCacheImpl(redisStr);
    SinoRail.DPC.Cache.CacheProvider.Initiate(cache, out message);
    // 实例化数据访问组件
    var clientConnection = new DataContextProvider()
    {
        ConnectionString = connStr,
        DbProviderFactory = factory,
        DatabaseType = DatabaseType.MySql
    };
    DataContextFactory dataContextFactory = new DataContextFactory(clientConnection);
    _dataAccess = new DefaultDbDataAccess(dataContextFactory);
    // 实例加密类
    SinoRail.Common.Security.ICryptoProvider cryptoProvider = new SinoRail.Common.Security.C3V2019001CryptoProvider();
    _services = new SafeguardImpl(_dataAccess, cryptoProvider);
    // 实例化数据保护类（单例访问）
    SinoRail.DPC.C3.Safeguard.SafeguardManager.Initialize(_services);
```
TODO: 写数据
```c# 
    [Test]
    public void SaveAlarmInfoTest()
    {
        var svr = SafeguardManager.Current;
        SinoRail.DPC.Model.C3.C3SafeAlarmInfo info = new SinoRail.DPC.Model.C3.C3SafeAlarmInfo()
        {
            Id = "20191025092403_9_CR400AF-2159_720_0_A.scs",
            GisX = 999
            // TODO ADD FIELDS
        };        

        bool succ = svr.SaveAlarmInfo(info);
        Assert.IsTrue(succ);
    }
```
TODO: 写数据
```c# 
    [Test]
    public void GetSaveAlarmInfoTest()
    {
        var svr = SafeguardManager.Current;
        string scsName = "20191025092403_9_CR400AF-2159_720_0_A.scs";
        var info = svr.GetAlarmInfo(scsName);
        Assert.IsNotNull(info);
    }
```